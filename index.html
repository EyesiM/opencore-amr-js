<!doctype html>
<!-- The Time Machine GitHub pages theme was designed and developed by Jon Rohan, on Feb 7, 2012. -->
<!-- Follow him for fun. http://twitter.com/jonrohan. Tail his code on http://github.com/jonrohan -->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <link rel="stylesheet" href="stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" href="stylesheets/pygment_trac.css">
  <script type="text/javascript" src="javascripts/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="javascripts/script.js"></script>
  <script type="text/javascript" src="amrnb.js"></script>

  <title>Opencore-amr-js</title>
  <meta name="description" content="">

  <meta name="viewport" content="width=device-width,initial-scale=1">

</head>

<body>

  <div class="wrapper">
    <header>
      <h1 class="title">Opencore-amr-js</h1>
    </header>
    <div id="container">
      <p class="tagline"></p>
      <div id="main" role="main">
        <div class="download-bar">
        <div class="inner">
          <a href="https://github.com/yxl/opencore-amr-js/tarball/master" class="download-button tar"><span>Download</span></a>
          <a href="https://github.com/yxl/opencore-amr-js/zipball/master" class="download-button zip"><span>Download</span></a>
          <a href="https://github.com/yxl/opencore-amr-js" class="code">View Opencore-amr-js on GitHub</a>
        </div>
        <span class="blc"></span><span class="trc"></span>
        </div>
        <article class="markdown-body">
          <h2>Test decoder</h2>
          <p id="test">
              Convert <a href="yuan.amr">yuan.amr</a> to wav file and compare with <a href="yuan.wav">yuan.wav</a>:
              <button>Test</button>
          </p>
          <h2>Decode amr file and play</h2>
          <p id="sample-amr">
              <button>Play</button> <a href="yuan.amr">yuan.amr</a>
          </p>
          <p>
              Select a local file and play: <input type="file" id="amr-file" accept=".amr">
          </p>
          <h2>Encode audio to amr file and play</h2>
          <p id="sample-audio">
              <button>Encode &amp; Play</button> <a href="hello.ogg">hello.ogg</a>
          </p>
          <p>
              Select a local file to encode and play: <input type="file" id="audio-file" accept="audio/*">
          </p>
          <h2>Amr to wav</h2>
          <p id="amr-to-wav">
              <button>Convert to wav and play</button> <a href="yuan.amr">yuan.amr</a>
          </p>
          <p>
              Select a local file, convert and play: <input type="file" id="amr-to-wav-file" accept=".amr">
          </p>
          <script>
              function E(selector) {
                  return document.querySelector(selector);
              }

              E('#test > button').onclick = function() {
                  fetchAndReadBlob('yuan.amr', function(amr) {
                      fetchAndReadBlob('yuan.wav', function(expected) {
                          var actual = AMR.toWAV(amr);
                          if (actual == null) {
                              alert('Failed to decode amr file.');
                              return;
                          }
                          if (actual.length != expected.length) {
                              alert('The converted wav file has different size.');
                              return;
                          }
                          for (var i = 0; i < actual.length; i++) {
                              if (actual[i] != expected[i]) {
                                  alert('The converted wav file has different content.');
                                  return;
                              }
                          }
                          alert('Succeeded!');
                      });
                  });
              };

              E('#sample-amr > button').onclick = function() {
                  fetchBlob(E('#sample-amr > a').href, function(blob) {
                      playAmrBlob(blob);
                  });
              };

              E('#amr-file').onchange = function() {
                  playAmrBlob(this.files[0]);
              };

              E('#amr-to-wav > button').onclick = function() {
                  fetchBlob(E('#amr-to-wav > a').href, function(blob) {
                      convertAmrBlobToWav(blob);
                  });
              };

              E('#amr-to-wav-file').onchange = function() {
                  convertAmrBlobToWav(this.files[0]);
              };

              E('#sample-audio > button').onclick = function() {
                  fetchBlob(E('#sample-audio > a').href, function(blob) {
                      convertAudioBlobToAmr(blob);
                  });
              };

              E('#audio-file').onchange = function() {
                  convertAudioBlobToAmr(this.files[0]);
              };

              var gAudioContext = new AudioContext();

              function getAudioContext() {
                  if (!gAudioContext) {
                      gAudioContext = new AudioContext();
                  }
                  return gAudioContext;
              }

              function fetchBlob(url, callback) {
                  var xhr = new XMLHttpRequest();
                  xhr.open('GET', url);
                  xhr.responseType = 'blob';
                  xhr.onload = function() {
                      callback(this.response);
                  };
                  xhr.onerror = function() {
                      alert('Failed to fetch ' + url);
                  };
                  xhr.send();
              }

              function readBlob(blob, callback) {
                  var reader = new FileReader();
                  reader.onload = function(e) {
                      var data = new Uint8Array(e.target.result);
                      callback(data);
                  };
                  reader.readAsArrayBuffer(blob);
              }

              function fetchAndReadBlob(url, callback) {
                  fetchBlob(url, function(blob) {
                      readBlob(blob, callback);
                  });
              }

              function playAmrBlob(blob, callback) {
                  readBlob(blob, function(data) {
                      playAmrArray(data);
                  });
              }

              function convertAudioBlobToAmr(blob) {
                  readBlob(blob, function(data) {
                      var ctx = getAudioContext();
                      ctx.decodeAudioData(data.buffer, function(audioBuffer) {
                          var pcm;
                          if (audioBuffer.copyFromChannel) {
                              pcm = new Float32Array(audioBuffer.length);
                              audioBuffer.copyFromChannel(pcm, 0, 0);
                          } else {
                              pcm = audioBuffer.getChannelData(0);
                          }
                          var amr = AMR.encode(pcm, audioBuffer.sampleRate, 7);
                          playAmrArray(amr);
                      });
                  });
              }

              function playAmrArray(array) {
                  var samples = AMR.decode(array);
                  if (!samples) {
                      alert('Failed to decode!');
                      return;
                  }
                  playPcm(samples);
              }

              function playPcm(samples) {
                  var ctx = getAudioContext();
                  var src = ctx.createBufferSource();
                  var buffer = ctx.createBuffer(1, samples.length, 8000);
                  if (buffer.copyToChannel) {
                      buffer.copyToChannel(samples, 0, 0)
                  } else {
                      var channelBuffer = buffer.getChannelData(0);
                      channelBuffer.set(samples);
                  }

                  src.buffer = buffer;
                  src.connect(ctx.destination);
                  src.start();
              }

              function convertAmrBlobToWav(blob) {
                  readBlob(blob, function(data) {
                      var buffer = AMR.toWAV(data);
                      var url = URL.createObjectURL(new Blob([buffer], { type: 'audio/x-wav' }));
                      // Play wav buffer
                      var audio = new Audio(url);
                      audio.onloadedmetadata = audio.onerror = function() {
                          URL.revokeObjectURL(url);
                      };
                      audio.play();
                  });
              }
          </script>

        </article>
      </div>
    </div>
    <footer>
      <div class="owner">
      <p><a href="https://github.com/yxl" class="avatar"><img src="https://avatars2.githubusercontent.com/u/1262683?v=3&amp;s=60" width="48" height="48"></a> <a href="https://github.com/yxl">yxl</a> maintains <a href="https://github.com/yxl/opencore-amr-js">Opencore-amr-js</a></p>


      </div>
      <div class="creds">
        <small>This page generated using <a href="http://pages.github.com/">GitHub Pages</a><br>theme by <a href="https://twitter.com/jonrohan/">Jon Rohan</a></small>
      </div>
    </footer>
  </div>
  <div class="current-section">
    <a href="#top">Scroll to top</a>
    <a href="https://github.com/yxl/opencore-amr-js/tarball/master" class="tar">tar</a><a href="https://github.com/yxl/opencore-amr-js/zipball/master" class="zip">zip</a><a href="" class="code">source code</a>
    <p class="name"></p>
  </div>

  
</body>
</html>
